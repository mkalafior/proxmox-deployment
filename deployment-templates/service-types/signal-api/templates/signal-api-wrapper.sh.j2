#!/bin/bash
# Signal CLI REST API Wrapper Script
# This script handles different execution modes and environment setup

# Set environment variables
export SIGNAL_CLI_CONFIG_DIR="{{ ansible_env.SIGNAL_CLI_CONFIG_DIR | default('/opt/signal-api/data') }}"
export MODE="{{ ansible_env.MODE | default('normal') }}"
export PORT="{{ ansible_env.PORT | default('8080') }}"
export LOG_LEVEL="{{ ansible_env.LOG_LEVEL | default('info') }}"
export JAVA_HOME="/usr/lib/jvm/java-{{ java_version | default('17') }}-openjdk-amd64"

# Add Go and Java to PATH
export PATH="/usr/local/go/bin:$JAVA_HOME/bin:$PATH"

# Ensure data directory exists and has correct permissions
mkdir -p "$SIGNAL_CLI_CONFIG_DIR"
chown {{ app_user }}:{{ app_user }} "$SIGNAL_CLI_CONFIG_DIR"

# Change to app directory
cd "{{ app_dir }}"

# Log startup
echo "$(date): Starting Signal CLI REST API in $MODE mode on port $PORT" >> /var/log/signal-api.log

# Execute the signal-cli-rest-api binary
exec ./{{ app_service_name }} "$@"
