# Node.js/Bun Dependency Installation Tasks
- name: Check if lockfile exists (Bun)
  stat:
    path: "{{ app_dir }}/bun.lock"
  register: bun_lockfile
  when: nodejs_runtime == "bun"

- name: Check if lockfile exists (npm)
  stat:
    path: "{{ app_dir }}/package-lock.json"
  register: npm_lockfile
  when: nodejs_runtime == "node"

- name: Install dependencies with npm
  shell: npm install --production
  args:
    chdir: "{{ app_dir }}"
  become_user: "{{ app_user }}"
  when: 
    - nodejs_runtime == "node"
    - npm_lockfile.stat.exists

- name: Install dependencies with Bun (with lockfile)
  shell: /usr/local/bin/bun install --production
  args:
    chdir: "{{ app_dir }}"
  become_user: "{{ app_user }}"
  when: 
    - nodejs_runtime == "bun"
    - bun_lockfile.stat.exists

- name: Create lockfile and install with Bun (no existing lockfile)
  shell: /usr/local/bin/bun install
  args:
    chdir: "{{ app_dir }}"
  become_user: "{{ app_user }}"
  when: 
    - nodejs_runtime == "bun"
    - not bun_lockfile.stat.exists

- name: Create lockfile with npm (no existing lockfile)
  shell: npm install --package-lock-only
  args:
    chdir: "{{ app_dir }}"
  become_user: "{{ app_user }}"
  when: 
    - nodejs_runtime == "node"
    - not npm_lockfile.stat.exists

